name: ZSXQ飞书机器人定时检测

on:
  # 使用定时任务，每10分钟运行一次
  schedule:
    - cron: '*/10 * * * *'  # 每10分钟运行一次
  # 也允许手动触发
  workflow_dispatch:

jobs:
  check-and-send:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: 检查是否在工作时间
      id: check_time
      run: |
        # 获取当前北京时间（UTC+8）
        CURRENT_TIME=$(TZ='Asia/Shanghai' date '+%H:%M')
        CURRENT_HOUR=$(TZ='Asia/Shanghai' date '+%H')
        CURRENT_MINUTE=$(TZ='Asia/Shanghai' date '+%M')
        
        echo "当前北京时间: $CURRENT_TIME"
        
        # 检查是否在 8:30-22:00 之间
        SHOULD_RUN=false
        if [ "$CURRENT_HOUR" -ge 8 ] && [ "$CURRENT_HOUR" -lt 22 ]; then
          if [ "$CURRENT_HOUR" -eq 8 ] && [ "$CURRENT_MINUTE" -lt 30 ]; then
            echo "8:30之前，不执行检测"
          else
            echo "在工作时间内，执行检测"
            SHOULD_RUN=true
          fi
        else
          echo "不在工作时间内，不执行检测"
        fi
        
        echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
        
    - name: 运行ZSXQ检测
      if: steps.check_time.outputs.should_run == 'true'
      run: |
        python main.py
      env:
        # 敏感信息通过GitHub Secrets配置
        ZSXQ_COOKIES: ${{ secrets.ZSXQ_COOKIES }}
        FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        FEISHU_SIGN_KEY: ${{ secrets.FEISHU_SIGN_KEY }}
        TARGET_GROUP_ID: ${{ secrets.TARGET_GROUP_ID }}
        TARGET_USER_ID: ${{ secrets.TARGET_USER_ID }}
        
    - name: 提交去重记录
      if: steps.check_time.outputs.should_run == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        # 强制添加sent_messages.json（即使被.gitignore忽略）
        git add sent_messages.json -f
        git diff --staged --quiet || git commit -m "更新消息去重记录 $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        git push